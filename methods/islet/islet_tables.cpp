#include "islet_types.hpp"
#include "islet_util.hpp"
#include "islet_tables.hpp"

namespace islet {

static const Real sqrt5 = std::sqrt(5.0);
static const Real oosqrt5 = 1.0/sqrt5;
static const Real sqrt3o7 = std::sqrt(3.0/7.0);
static const Real np6a = std::sqrt(1.0/3.0 + 2.0*std::sqrt(7.0)/21.0);
static const Real np6b = std::sqrt(1.0/3.0 - 2.0*std::sqrt(7.0)/21.0);
static const Real np7a = std::sqrt((5.0 + 2.0*std::sqrt(5.0/3.0))/11.0);
static const Real np7b = std::sqrt((5.0 - 2.0*std::sqrt(5.0/3.0))/11.0);

Real x_gll_table[] = {
  -1, 1,
  -1, 0, 1,
  -1, -oosqrt5, oosqrt5, 1,
  -1, -sqrt3o7, 0, sqrt3o7, 1,
  -1, -np6a, -np6b, np6b, np6a, 1,
  -1, -np7a, -np7b, 0, np7b, np7a, 1,
  // The rest are obtained from Michels, H. H. "Abscissas and weight
  // coefficients for Lobatto quadrature." Mathematics of Computation 17.83
  // (1963): 237-244.
  // np 8
  -1, -0.8717401485096066153, -0.59170018143314230214, -0.20929921790247886877,
  0.20929921790247886877, 0.59170018143314230214, 0.87174014850960661534, 1,
  // np 9
  -1, -0.89975799541146015731, -0.67718627951073775345, -0.36311746382617815871,
  0, 0.36311746382617815871, 0.67718627951073775345, 0.89975799541146015731, 1,
  // np 10
  -1, -0.91953390816645881383, -0.73877386510550507500, -0.47792494981044449566,
  -0.16527895766638702463, 0.16527895766638702463, 0.47792494981044449566,
  0.73877386510550507500, 0.91953390816645881383, 1,
  // np 11
  -1, -0.93400143040805913433, -0.78448347366314441862, -0.56523532699620500647,
  -0.29575813558693939143, 0, 0.29575813558693939143, 0.56523532699620500647,
  0.78448347366314441862, 0.93400143040805913433, 1,
  // np 12
  -1, -0.94489927222288222341, -0.81927932164400667835, -0.63287615303186067766,
  -0.39953094096534893226, -0.13655293285492755486, 0.13655293285492755486,
  0.39953094096534893226, 0.63287615303186067766, 0.81927932164400667835,
  0.94489927222288222341, 1,
  // np 13
  -1, -0.95330984664216391190, -0.84634756465187231687, -0.68618846908175742607,
  -0.48290982109133620175, -0.24928693010623999257, 0, 0.24928693010623999257,
  0.48290982109133620175, 0.68618846908175742607, 0.84634756465187231687,
  0.95330984664216391190, 1,
  // np 16
  -1, -0.96956804627021793295, -0.89920053309347209299, -0.79200829186181506393,
  -0.65238870288249308947, -0.48605942188713761178, -0.29983046890076320810,
  -0.10132627352194944784, 0.10132627352194944784, 0.29983046890076320810,
  0.48605942188713761178, 0.65238870288249308947, 0.79200829186181506393,
  0.89920053309347209299, 0.96956804627021793295, 1
};

Real w_gll_table[] = {
  1, 1,
#define v0 1.0/3.0
  v0, 4.0/3.0, v0,
#undef v0
#define v0 1.0/6.0
#define v1 5.0/6.0
  v0, v1, v1, v0,
#undef v0
#undef v1
#define v0 1.0/10.0
#define v1 49.0/90.0
  v0, v1, 32.0/45.0, v1, v0,
#undef v0
#undef v1
#define v0 1.0/15.0
#define v1 (14 - std::sqrt(7.0))/30.0
#define v2 (14 + std::sqrt(7.0))/30.0
  v0, v1, v2, v2, v1, v0,
#undef v0
#undef v1
#undef v2
#define v0 1.0/21.0
#define v1 (124 - 7*std::sqrt(15.0))/350.0
#define v2 (124 + 7*std::sqrt(15.0))/350.0
  v0, v1, v2, 256.0/525.0, v2, v1, v0,
#undef v0
#undef v1
#undef v2
  // The rest are obtained from the reference in x_gll_table.
  // np 8
  0.03571428571428571429, 0.21070422714350603938, 0.34112269248350436476,
  0.41245879465870388157, 0.41245879465870388157, 0.34112269248350436476,
  0.21070422714350603938, 0.03571428571428571429,
  // np 9
  0.02777777777777777778, 0.16549536156080552505, 0.27453871250016173528,
  0.34642851097304634512, 0.37151927437641723356, 0.34642851097304634512,
  0.27453871250016173528, 0.16549536156080552505, 0.02777777777777777778,
  // np 10
  0.02222222222222222222, 0.13330599085107011113, 0.22488934206312645212,
  0.29204268367968375788, 0.32753976118389745666, 0.32753976118389745666,
  0.29204268367968375788, 0.22488934206312645212, 0.13330599085107011113,
  0.02222222222222222222,
  // np 11
  0.01818181818181818182, 0.10961227326699486446, 0.18716988178030520411,
  0.24804810426402831404, 0.28687912477900808868, 0.30021759545569069379,
  0.28687912477900808868, 0.24804810426402831404, 0.18716988178030520411,
  0.10961227326699486446, 0.01818181818181818182,
  // np 12
  0.01515151515151515152, 0.09168451741319613067, 0.15797470556437011517,
  0.21250841776102114536, 0.25127560319920128029, 0.27140524091069617700,
  0.27140524091069617700, 0.25127560319920128029, 0.21250841776102114536,
  0.15797470556437011517, 0.09168451741319613067, 0.01515151515151515152,
  // np 13
  0.01282051282051282051, 0.07780168674681892779, 0.13498192668960834912,
  0.18364686520355009201, 0.22076779356611008609, 0.24401579030667635646,
  0.25193084933344673604, 0.24401579030667635646, 0.22076779356611008609,
  0.18364686520355009201, 0.13498192668960834912, 0.07780168674681892779,
  0.01282051282051282051,
  // np 16
  0.00833333333333333333, 0.05085036100591990540, 0.08939369732593080099,
  0.12425538213251409835, 0.15402698080716428081, 0.17749191339170412530,
  0.19369002382520358432, 0.20195830817822987149, 0.20195830817822987149,
  0.19369002382520358432, 0.17749191339170412530, 0.15402698080716428081,
  0.12425538213251409835, 0.08939369732593080099, 0.05085036100591990540,
  0.00833333333333333333
};

/* These Gauss-Legendre tables were obtained using
   $ gsl-config --version
   1.15
   with calls to
   gsl_integration_glfixed_table_alloc
   gsl_integration_glfixed_point
       gsl_integration_glfixed_table_free.
 */

Real x_gl_table[] = {
  // np 1
  0.000000000000000000,
  // np 2
  -0.577350269189625731,  0.577350269189625731,
  // np 3
  -0.774596669241483404,  0.000000000000000000,  0.774596669241483404,
  // np 4
  -0.861136311594052573, -0.339981043584856257,  0.339981043584856257,
  0.861136311594052573,
  // np 5
  -0.906179845938663964, -0.538469310105683108,  0.000000000000000000,
  0.538469310105683108,  0.906179845938663964,
  // np 6
  -0.932469514203152050, -0.661209386466264482, -0.238619186083196905,
  0.238619186083196905,  0.661209386466264482,  0.932469514203152050,
  // np 7
  -0.949107912342758486, -0.741531185599394460, -0.405845151377397184,
  0.000000000000000000,  0.405845151377397184,  0.741531185599394460,
  0.949107912342758486,
  // np 8
  -0.960289856497536287, -0.796666477413626728, -0.525532409916328991,
  -0.183434642495649808,  0.183434642495649808,  0.525532409916328991,
  0.796666477413626728,  0.960289856497536287,
  // np 9
  -0.968160239507626086, -0.836031107326635770, -0.613371432700590358,
  -0.324253423403808916,  0.000000000000000000,  0.324253423403808916,
  0.613371432700590358,  0.836031107326635770,  0.968160239507626086,
  // np 10
  -0.973906528517171743, -0.865063366688984536, -0.679409568299024436,
  -0.433395394129247213, -0.148874338981631216,  0.148874338981631216,
  0.433395394129247213,  0.679409568299024436,  0.865063366688984536,
  0.973906528517171743,
  // np 11
  -0.978228658146056973, -0.887062599768095317, -0.730152005574049356,
  -0.519096129206811807, -0.269543155952344959,  0.000000000000000000,
  0.269543155952344959,  0.519096129206811807,  0.730152005574049356,
  0.887062599768095317,  0.978228658146056973,
  // np 12
  -0.981560634246719244, -0.904117256370474909, -0.769902674194304693,
  -0.587317954286617483, -0.367831498998180184, -0.125233408511468913,
  0.125233408511468913,  0.367831498998180184,  0.587317954286617483,
  0.769902674194304693,  0.904117256370474909,  0.981560634246719244  
};

Real w_gl_table[] = {
  // np 1
  2.000000000000000000,
  // np 2
  1.000000000000000000,  1.000000000000000000,
  // np 3
  0.555555555555555580,  0.888888888888888840,  0.555555555555555580,
  // np 4
  0.347854845137453850,  0.652145154862546095,  0.652145154862546095,
  0.347854845137453850,
  // np 5
  0.236926885056189085,  0.478628670499366471,  0.568888888888888888,
  0.478628670499366471,  0.236926885056189085,
  // np 6
  0.171324492379170357,  0.360761573048138606,  0.467913934572691037,
  0.467913934572691037,  0.360761573048138606,  0.171324492379170357,
  // np 7
  0.129484966168869703,  0.279705391489276645,  0.381830050505118923,
  0.417959183673469403,  0.381830050505118923,  0.279705391489276645,
  0.129484966168869703,
  // np 8
  0.101228536290376259,  0.222381034453374482,  0.313706645877887269,
  0.362683783378361990,  0.362683783378361990,  0.313706645877887269,
  0.222381034453374482,  0.101228536290376259,
  // np 9
  0.081274388361574412,  0.180648160694857396,  0.260610696402935438,
  0.312347077040002863,  0.330239355001259782,  0.312347077040002863,
  0.260610696402935438,  0.180648160694857396,  0.081274388361574412,
  // np 10
  0.066671344308688138,  0.149451349150580587,  0.219086362515982042,
  0.269266719309996350,  0.295524224714752870,  0.295524224714752870,
  0.269266719309996350,  0.219086362515982042,  0.149451349150580587,
  0.066671344308688138,
  // np 11
  0.055668567116173663,  0.125580369464904612,  0.186290210927734262,
  0.233193764591990482,  0.262804544510246652,  0.272925086777900616,
  0.262804544510246652,  0.233193764591990482,  0.186290210927734262,
  0.125580369464904612,  0.055668567116173663,
  // np 12
  0.047175336386511828,  0.106939325995318427,  0.160078328543346221,
  0.203167426723065925,  0.233492536538354806,  0.249147045813402773,
  0.249147045813402773,  0.233492536538354806,  0.203167426723065925,
  0.160078328543346221,  0.106939325995318427,  0.047175336386511828
};

bool get_gll_supported (const Int np) { return np >= 2 && np <= 13 || np == 16; }

const Real* get_x_gll (const Int np) {
  throw_if(np <  2, "get_x_gll: np <  2 not supported.");
  if (np <= 13)
    return x_gll_table + (np*(np-1))/2 - 1;
  else
    return get_x_gll_special(np);
}

const Real* get_w_gll (const Int np) {
  throw_if(np <  2, "get_x_gll: np <  2 not supported.");
  if (np <= 13)
    return w_gll_table + (np*(np-1))/2 - 1;
  else
    return get_w_gll_special(np);
}

const Real* get_x_gll_special (const Int np) {
  if (np <= 13) return get_x_gll(np);
  throw_if(np != 16, "np 16 only is supported");
  const auto end = x_gll_table + (14*(14-1))/2 - 1;
  return end;
}

const Real* get_w_gll_special (const Int np) {
  if (np <= 13) return get_w_gll(np);
  throw_if(np != 16, "np 16 only is supported");
  const auto end = w_gll_table + (14*(14-1))/2 - 1;
  return end;
}

const Real* get_x_gl (const Int np) {
  throw_if(np <  1, "get_x_gll: np <  1 not supported.");
  throw_if(np > 12, "get_x_gll: np > 12 not supported.");
  return x_gl_table + (np*(np-1))/2;
}

const Real* get_w_gl (const Int np) {
  throw_if(np <  1, "get_x_gll: np <  1 not supported.");
  throw_if(np > 12, "get_w_gll: np > 12 not supported.");
  return w_gl_table + (np*(np-1))/2;
}

} // namespace islet
